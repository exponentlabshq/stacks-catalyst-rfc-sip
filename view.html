<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SIP Viewer</title>
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .viewer { max-width: 900px; margin: 24px auto; padding: 0 24px; }
      .prose { line-height: 1.6; }
      .prose h1, .prose h2, .prose h3 { margin-top: 1.6em; }
      .prose pre { overflow: auto; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-weak); }
      .back { display: inline-block; margin: 16px 0; color: var(--muted); text-decoration: none; }
      .back:hover { color: var(--text); }
    </style>
  </head>
  <body>
    <main class="viewer">
      <a class="back" href="index.html">‚Üê Back</a>
      <article id="content" class="prose"></article>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script>
      (async () => {
        const params = new URLSearchParams(location.search);
        const src = params.get('src');
        const el = document.getElementById('content');
        if (!src) { el.textContent = 'Missing src param'; return; }
        const abs = src; // served same-origin

        const res = await fetch(abs, { cache: 'no-store' });
        if (!res.ok) { el.textContent = 'Failed to load markdown'; return; }
        const md = await res.text();
        const mg = window.marked;
        const parse = mg ? (typeof mg.parse === 'function' ? mg.parse : (typeof mg === 'function' ? mg : null)) : null;
        if (!parse) { el.textContent = 'Markdown renderer failed to load.'; return; }
        const rawHtml = parse(md);

        // Safely rewrite relative links/media to be relative to the md file path
        const base = abs.split('/').slice(0, -1).join('/');
        const container = document.createElement('div');
        container.innerHTML = rawHtml;
        const isRelative = (v) => v && !/^(?:[a-z]+:|\/|#|data:)/i.test(v);
        const fix = (node, attr) => {
          const v = node.getAttribute(attr);
          if (isRelative(v)) node.setAttribute(attr, `${base}/${v.replace(/^\.\//,'')}`);
        };
        container.querySelectorAll('img,source,video,script,link').forEach(n => fix(n, 'src'));
        container.querySelectorAll('a').forEach(n => fix(n, 'href'));

        const purifier = window.DOMPurify && window.DOMPurify.sanitize ? window.DOMPurify : null;
        el.innerHTML = purifier ? purifier.sanitize(container.innerHTML) : container.innerHTML;
      })();
    </script>
  </body>
  </html>


