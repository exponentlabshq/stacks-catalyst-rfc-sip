<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Submitted SIPs</title>
    <link rel="icon" href="/favicon/favicon.ico" sizes="any" />
    <link rel="stylesheet" href="./styles.css" />
    <style>
      body { background: #dae0e6; }
      .feed { max-width: 740px; margin: 16px auto; padding: 0 12px; }
      .post { display: grid; grid-template-columns: 40px auto; background: #fff; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
      .vote-col { background: #f8f9fa; display: grid; align-content: center; justify-items: center; padding: 8px 0; border-right: 1px solid #ededed; }
      .vote-btn { cursor: pointer; user-select: none; font-size: 18px; line-height: 1; padding: 4px; color: #878a8c; }
      .vote-btn.up.active { color: #ff4500; }
      .vote-btn.down.active { color: #7193ff; }
      .score { font-weight: 600; color: #1a1a1b; font-size: 13px; margin: 4px 0; }
      .post-body { padding: 8px 10px 10px 10px; }
      .post-title { margin: 2px 0 4px 0; font-size: 16px; font-weight: 600; }
      .post-title a { color: #1a1a1b; text-decoration: none; }
      .post-title a:hover { text-decoration: underline; }
      .post-meta { color: #7c7c7c; font-size: 12px; }
      .tag { display: inline-block; background: #f6f7f8; color: #636669; border: 1px solid #e2e3e5; padding: 2px 6px; border-radius: 12px; font-size: 11px; margin-right: 6px; }
      .action-bar { display: flex; gap: 16px; color: #7c7c7c; font-size: 12px; margin-top: 8px; }
      .action { cursor: pointer; text-decoration: none; color: inherit; }
      .action:hover { color: #1a1a1b; }
      .toolbar { display:flex; gap:10px; align-items:center; justify-content: space-between; margin: 10px auto; max-width: 740px; padding: 0 12px; }
      .tab { display:inline-flex; align-items:center; padding: 6px 10px; border: 1px solid #e2e3e5; background:#fff; color:#1a1a1b; border-radius: 4px; text-decoration:none; font-size: 13px; }
      .tab.active { border-color:#ff4500; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <div class="hero">
          <h1 class="title">Submitted SIPs</h1>
          <p class="subtitle">Reddit-style voting. Local-only (simulated) upvotes/downvotes.</p>
        </div>
      </div>
    </header>

    <nav class="toolbar">
      <div>
        <a class="chip" href="pre.html">← Home</a>
        <a class="chip" href="index.html">SIPs Explorer</a>
        <a class="chip" href="submit-sip.html">Submit a SIP</a>
      </div>
      <div>
        <a class="chip" href="#" id="sortHot">Hot</a>
        <a class="chip" href="#" id="sortTop">Top</a>
        <a class="chip" href="#" id="sortNew">New</a>
      </div>
    </nav>

    <main class="feed" id="list" aria-live="polite"></main>

    <script>
      const $ = (s,r=document)=>r.querySelector(s);
      const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
      const key = 'submittedVotesV1';
      const getVotes = () => JSON.parse(localStorage.getItem(key) || '{}');
      const setVotes = (m) => localStorage.setItem(key, JSON.stringify(m));

      let data = [];
      let mode = 'hot';

      const scoreOf = (it) => {
        const local = getVotes()[it.id];
        const base = (it.votes?.up || 0) - (it.votes?.down || 0);
        const delta = local === 1 ? 1 : local === -1 ? -1 : 0;
        return base + delta;
      };

      function sortData() {
        if (mode === 'top') return data.sort((a,b)=>scoreOf(b)-scoreOf(a));
        if (mode === 'new') return data.sort((a,b)=>new Date(b.created)-new Date(a.created));
        // simple hot: score + recency weight
        return data.sort((a,b)=> (scoreOf(b) + freshness(b)) - (scoreOf(a) + freshness(a)));
      }

      const freshness = (it) => {
        const days = Math.max(1, (Date.now()-new Date(it.created).getTime())/86400000);
        return 1/Math.log2(3+days); // mild boost for newer
      };

      function renderItem(it){
        const s = scoreOf(it);
        const local = getVotes()[it.id] || 0;
        const tags = (it.consideration||[]).map(c=>`<span class=\"tag\">${c}</span>`).join(' ');
        const comments = it.comments || 0;
        const author = it.author ? ` • by ${it.author}` : '';
        return `
          <article class=\"post\" data-id=\"${it.id}\">\n            <div class=\"vote-col\">\n              <div class=\"vote-btn up ${local===1?'active':''}\" data-vote=\"up\">▲</div>\n              <div class=\"score\">${s}</div>\n              <div class=\"vote-btn down ${local===-1?'active':''}\" data-vote=\"down\">▼</div>\n            </div>\n            <div class=\"post-body\">\n              <div class=\"post-title\"><a href=\"#\">[SIP-${it.sip || 'TBD'}] ${it.title}</a></div>\n              <div class=\"post-meta\">${new Date(it.created).toLocaleDateString()} • ${it.type || ''} • ${it.status || ''}${author}</div>\n              <div style=\"margin-top:6px;\">${tags}</div>\n              <div class=\"action-bar\">\n                <a class=\"action\" href="${it.url || it.discussions || '#'}" target="_blank" rel="noopener noreferrer">Forum thread</a>
                <a class=\"action\" href=\"#\" data-action=\"copy\">Copy</a>\n                <a class=\"action\" href=\"#\" data-action=\"discuss\">Discuss</a>\n                <span class=\"action\">${comments} comments</span>\n              </div>\n            </div>\n          </article>\n        `;
      }

      function render(){
        const list = $('#list');
        list.innerHTML = sortData().map(renderItem).join('');
        // attach handlers
        $$('.post').forEach(card => {
          const id = card.getAttribute('data-id');
          card.querySelector('[data-vote="up"]').onclick = () => vote(id, 1);
          card.querySelector('[data-vote="down"]').onclick = () => vote(id, -1);
          const viewEl = card.querySelector('[data-action="view"]'); if (viewEl) viewEl.onclick = () => openMarkdown(id);
          card.querySelector('[data-action="copy"]').onclick = () => copyMarkdown(id);
          card.querySelector('[data-action="discuss"]').onclick = () => openDiscuss(id);
        });
      }

      function vote(id, dir){
        const votes = getVotes();
        votes[id] = (votes[id] === dir) ? 0 : dir; // toggle
        setVotes(votes);
        render();
      }

      function findItem(id){ return data.find(x => x.id === id); }

      function openMarkdown(id){
        const it = findItem(id); if (!it) return;
        const blob = new Blob([it.markdown || it.abstract || it.title], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      }

      async function copyMarkdown(id){
        const it = findItem(id); if (!it) return;
        const md = it.markdown || it.abstract || it.title;
        try { await navigator.clipboard.writeText(md); alert('Markdown copied'); }
        catch { const ta=document.createElement('textarea'); ta.value=md; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('Markdown copied (fallback)'); }
      }

      function openDiscuss(id){
        const it = findItem(id); if (!it) return;
        const url = it.discussions || 'https://forum.stacks.org';
        window.open(url, '_blank');
      }

      async function init(){
        const res = await fetch('submitted-sips.json', { cache: 'no-store' });
        data = await res.json();
        render();
      }

      $('#sortHot').onclick = (e)=>{ e.preventDefault(); mode='hot'; render(); };
      $('#sortTop').onclick = (e)=>{ e.preventDefault(); mode='top'; render(); };
      $('#sortNew').onclick = (e)=>{ e.preventDefault(); mode='new'; render(); };

      init();
    </script>
  </body>
  </html>


